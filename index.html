<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Kokoro ‚Äî –ü—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –¥–ª—è –¥–≤–æ–∏—Ö</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-main: #fdfcff;
            --text-main: #3d3d3d;
            --text-secondary: #a0a0b0;
            --accent-pink: #fce7f3;
            --accent-pink-dark: #ec4899;
            --accent-blue: #e0f2fe;
            --accent-blue-dark: #38bdf8;
            --accent-mint: #d1fae5;
            --accent-mint-dark: #34d399;
            --accent-lavender: #e5e7ff;
            --accent-lavender-dark: #818cf8;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-main); color: var(--text-main); overscroll-behavior-y: none; }
        @keyframes breathe { 0%, 100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(129, 140, 248, 0.4); } 50% { transform: scale(1.05); box-shadow: 0 0 10px 15px rgba(129, 140, 248, 0); } }
        .breathing-circle { animation: breathe 5s ease-in-out infinite; }
        .page { display: none; animation: fadeIn 0.5s ease-in-out; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .modal-backdrop { background-color: rgba(0,0,0,0.5); transition: opacity 0.3s ease-in-out; }
        .modal-content { transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out; }
        .modal-hidden .modal-backdrop { opacity: 0; }
        .modal-hidden .modal-content { transform: translateY(20px); opacity: 0; }
        button:disabled { opacity: 0.7; cursor: not-allowed; }
    </style>
</head>
<body class="antialiased">

    <!-- –≠–∫—Ä–∞–Ω—ã –∏ HTML-—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ -->
    <div id="loading-container" class="max-w-sm mx-auto min-h-screen bg-[var(--bg-main)] flex flex-col justify-center items-center p-8">
        <div class="text-2xl font-bold">Kokoro ‚ù§Ô∏è</div>
        <div class="text-gray-500 mt-2">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>
    <div id="login-container" style="display: none;" class="max-w-sm mx-auto min-h-screen bg-[var(--bg-main)] flex flex-col justify-center p-8">
        <div class="text-center">
            <h1 class="text-3xl font-bold text-[var(--text-main)] tracking-tight">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Kokoro ‚ù§Ô∏è</h1>
            <p class="text-md text-[var(--text-secondary)] mt-2 mb-8">–í–æ–π–¥–∏—Ç–µ —á–µ—Ä–µ–∑ Telegram, —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å –≤–∞—à–µ –ª–∏—á–Ω–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ.</p>
            <button onclick="window.app.loginWithTelegram()" class="w-full bg-[#2AABEE] text-white font-bold py-4 px-6 rounded-full transition-transform duration-200 active:scale-95 shadow-lg shadow-blue-500/30 flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M15 10l-4 4 6 6 4-16-18 7 4 2 2 6 3-4z"></path></svg>
                –í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Telegram
            </button>
        </div>
    </div>
    <div id="app-container" style="display: none;" class="max-w-sm mx-auto min-h-screen bg-[var(--bg-main)] shadow-2xl shadow-purple-200/50 flex flex-col">
        <header class="p-4 text-center sticky top-0 bg-[var(--bg-main)]/80 backdrop-blur-sm z-10">
            <h1 id="header-title" class="text-xl font-bold text-[var(--text-main)] tracking-tight">Kokoro ‚ù§Ô∏è</h1>
        </header>
        <main class="flex-grow p-4 overflow-y-auto">
            <div id="page-home" class="page space-y-6"></div>
            <div id="page-calendar" class="page"></div>
            <div id="page-chat" class="page flex flex-col h-full"></div>
            <div id="page-games" class="page"></div>
            <div id="page-profile" class="page"></div>
        </main>
        <nav class="sticky bottom-0 bg-white/70 backdrop-blur-sm p-2 rounded-t-2xl shadow-[0_-10px_30px_-15px_rgba(0,0,0,0.1)]">
            <div class="flex justify-around">
                <button onclick="window.navigate('home')" class="nav-item active flex-1 flex flex-col items-center p-2 rounded-lg text-[var(--accent-lavender-dark)]"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg><span class="text-xs mt-1">–ì–ª–∞–≤–Ω–∞—è</span></button>
                <button onclick="window.navigate('calendar')" class="nav-item flex-1 flex flex-col items-center p-2 rounded-lg text-[var(--text-secondary)]"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg><span class="text-xs mt-1">–ö–∞–ª–µ–Ω–¥–∞—Ä—å</span></button>
                <button onclick="window.navigate('chat')" class="nav-item flex-1 flex flex-col items-center p-2 rounded-lg text-[var(--text-secondary)]"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg><span class="text-xs mt-1">–ß–∞—Ç</span></button>
                <button onclick="window.navigate('games')" class="nav-item flex-1 flex flex-col items-center p-2 rounded-lg text-[var(--text-secondary)]"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><path d="M16 8h.01"></path><path d="M12 12h.01"></path><path d="M8 16h.01"></path><path d="M8 8h.01"></path><path d="M16 16h.01"></path></svg><span class="text-xs mt-1">–ò–≥—Ä—ã</span></button>
                <button onclick="window.navigate('profile')" class="nav-item flex-1 flex flex-col items-center p-2 rounded-lg text-[var(--text-secondary)]"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg><span class="text-xs mt-1">–ü—Ä–æ—Ñ–∏–ª—å</span></button>
            </div>
        </nav>
    </div>
    <div id="invite-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-hidden" onclick="window.app.closeAllModals()"><div class="modal-backdrop fixed inset-0"></div><div class="modal-content bg-white rounded-2xl shadow-xl w-full max-w-sm p-6 text-center" onclick="event.stopPropagation()"><h3 class="text-lg font-bold mb-2">–ü—Ä–∏–≥–ª–∞—Å–∏—Ç–µ –ø–∞—Ä—Ç–Ω—ë—Ä–∞</h3><p class="text-sm text-gray-600 mb-4">–û—Ç–ø—Ä–∞–≤—å—Ç–µ —ç—Ç–æ—Ç ID –≤–∞—à–µ–º—É –ø–∞—Ä—Ç–Ω—ë—Ä—É.</p><div class="bg-gray-100 p-3 rounded-lg font-mono text-lg mb-4 break-all" id="user-id-display"></div><button onclick="window.app.copyUserId()" class="w-full bg-[var(--accent-lavender-dark)] text-white font-semibold py-3 rounded-full">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å ID</button></div></div>
    <div id="connect-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-hidden" onclick="window.app.closeAllModals()"><div class="modal-backdrop fixed inset-0"></div><div class="modal-content bg-white rounded-2xl shadow-xl w-full max-w-sm p-6 text-center" onclick="event.stopPropagation()"><h3 class="text-lg font-bold mb-2">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –ø–∞—Ä—Ç–Ω—ë—Ä—É</h3><p class="text-sm text-gray-600 mb-4">–í–≤–µ–¥–∏—Ç–µ ID –≤–∞—à–µ–≥–æ –ø–∞—Ä—Ç–Ω—ë—Ä–∞.</p><input id="partner-id-input" type="text" placeholder="ID –ø–∞—Ä—Ç–Ω—ë—Ä–∞" class="w-full text-center p-3 rounded-lg bg-gray-100 border focus:ring-2 focus:ring-[var(--accent-lavender-dark)] focus:outline-none mb-4"><button onclick="window.app.connectPartner()" class="w-full bg-[var(--accent-lavender-dark)] text-white font-semibold py-3 rounded-full">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button></div></div>
    <div id="notification" class="fixed top-5 left-1/2 -translate-x-1/2 bg-green-500 text-white py-2 px-5 rounded-full text-sm shadow-lg opacity-0 pointer-events-none translate-y-[-20px] transition-all duration-500 z-50"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ---
        let db, auth, tgUser, userId, unsubscribeUser;
        const loadingContainer = document.getElementById('loading-container');
        const loginContainer = document.getElementById('login-container');
        const appContainer = document.getElementById('app-container');

        // --- –®–∞–±–ª–æ–Ω—ã –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü (–¥–ª—è —á–∏—Å—Ç–æ—Ç—ã –∫–æ–¥–∞) ---
        const pageTemplates = {
            home: `
                <div class="text-center">
                    <h2 class="text-2xl font-bold">–î–ª—è —Ç–µ–±—è –∏ –º–µ–Ω—è</h2>
                    <p class="text-md text-[var(--text-secondary)]">–ú–∞–ª–µ–Ω—å–∫–∏–µ —Ä–∏—Ç—É–∞–ª—ã –∏ –±–æ–ª—å—à–∏–µ —á—É–≤—Å—Ç–≤–∞</p>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-lg shadow-yellow-500/10 text-center">
                    <p class="text-lg font-semibold mb-2">‚ú® –ò–¥–µ—è –¥–ª—è —Å–≤–∏–¥–∞–Ω–∏—è</p>
                    <p id="date-idea-content" class="text-sm text-[var(--text-secondary)] mb-4 min-h-[40px] flex items-center justify-center">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –Ω–æ–≤—É—é –∏–¥–µ—é!</p>
                    <button id="date-idea-button" onclick="window.app.generateDateIdea()" class="bg-yellow-100 text-yellow-800 font-semibold py-2 px-6 rounded-full transition-transform duration-200 active:scale-95">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-lg shadow-pink-500/10 text-center">
                    <p class="text-lg font-semibold mb-3">–î—É–º–∞—é –æ —Ç–µ–±–µ</p>
                    <p class="text-sm text-[var(--text-secondary)] mb-4">–û—Ç–ø—Ä–∞–≤—å —Å–∏–≥–Ω–∞–ª, —á—Ç–æ —Ç–≤–æ–π –ø–∞—Ä—Ç–Ω—ë—Ä —Å–µ–π—á–∞—Å –≤ –º—ã—Å–ª—è—Ö.</p>
                    <button onclick="window.app.sendThinking()" class="bg-[var(--accent-pink)] text-[var(--accent-pink-dark)] w-20 h-20 rounded-full flex items-center justify-center mx-auto transition-transform duration-200 active:scale-90">
                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>
                    </button>
                </div>`,
            games: `
                <div class="space-y-4">
                    <div class="p-5 rounded-2xl bg-gradient-to-br from-[var(--accent-pink)] to-white shadow-lg shadow-pink-500/20"><h3 class="text-xl font-bold text-[var(--accent-pink-dark)] mb-1">–§–æ—Ç–æ-–∞—Å—Å–æ—Ü–∏–∞—Ü–∏–∏</h3><p class="text-sm text-[var(--text-main)]/70 mb-4">–°—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä—É–π —Ç–æ, —á—Ç–æ –Ω–∞–ø–æ–º–∏–Ω–∞–µ—Ç —Ç–µ–±–µ –æ –ø–∞—Ä—Ç–Ω—ë—Ä–µ.</p><button class="bg-white text-[var(--accent-pink-dark)] font-semibold py-2 px-5 rounded-full text-sm">–ò–≥—Ä–∞—Ç—å</button></div>
                    <div class="p-5 rounded-2xl bg-gradient-to-br from-[var(--accent-blue)] to-white shadow-lg shadow-blue-500/20"><h3 class="text-xl font-bold text-[var(--accent-blue-dark)] mb-1">–ß–∏—Å–ª–æ–≤–æ–π —á–µ–ª–ª–µ–Ω–¥–∂</h3><p class="text-sm text-[var(--text-main)]/70 mb-4">–ò—â–∏—Ç–µ –≤–º–µ—Å—Ç–µ —á–∏—Å–ª–∞ –æ—Ç 1 –¥–æ 100 –≤ –æ–∫—Ä—É–∂–∞—é—â–µ–º –º–∏—Ä–µ.</p><button class="bg-white text-[var(--accent-blue-dark)] font-semibold py-2 px-5 rounded-full text-sm">–ò–≥—Ä–∞—Ç—å</button></div>
                    <div class="p-5 rounded-2xl bg-gradient-to-br from-[var(--accent-lavender)] to-white shadow-lg shadow-purple-500/20">
                        <h3 class="text-xl font-bold text-[var(--accent-lavender-dark)] mb-1">‚ú® –ü—Ä–∞–≤–¥–∞ –∏–ª–∏ –î–µ–π—Å—Ç–≤–∏–µ</h3>
                        <div id="truth-dare-content" class="text-sm text-[var(--text-main)]/80 my-4 min-h-[60px] flex items-center justify-center text-center">–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –∑–∞–¥–∞–Ω–∏–µ.</div>
                        <div class="flex space-x-2">
                           <button id="truth-btn" onclick="window.app.generateTruthOrDare('truth')" class="flex-1 bg-white text-[var(--accent-lavender-dark)] font-semibold py-2 px-5 rounded-full text-sm">–ü—Ä–∞–≤–¥–∞</button>
                           <button id="dare-btn" onclick="window.app.generateTruthOrDare('dare')" class="flex-1 bg-white text-[var(--accent-lavender-dark)] font-semibold py-2 px-5 rounded-full text-sm">–î–µ–π—Å—Ç–≤–∏–µ</button>
                        </div>
                    </div>
                </div>`,
            profile: `
                <div class="text-center">
                    <img id="profile-avatar" src="https://placehold.co/128x128/e5e7ff/818cf8?text=You" class="w-32 h-32 rounded-full object-cover mx-auto mb-4 border-4 border-white shadow-lg">
                    <h2 id="profile-nickname" class="text-2xl font-bold">–í–∞—à –Ω–∏–∫</h2>
                    <p class="text-md text-[var(--text-secondary)]">–≠—Ç–æ –≤—ã</p>
                </div>
                <hr class="my-8 border-t border-gray-200">
                <div id="partner-view" class="text-center" style="display: none;">
                    <img id="partner-avatar" src="https://placehold.co/128x128/fce7f3/ec4899?text=?" class="w-32 h-32 rounded-full object-cover mx-auto mb-4 border-4 border-white shadow-lg">
                    <h2 id="partner-nickname" class="text-2xl font-bold">–ü–∞—Ä—Ç–Ω—ë—Ä</h2>
                     <button onclick="window.app.disconnectPartner()" class="mt-4 bg-red-100 text-red-600 font-semibold py-2 px-6 rounded-full text-sm">–†–∞–∑–æ—Ä–≤–∞—Ç—å —Å–≤—è–∑—å</button>
                </div>
                <div id="invite-view" class="text-center">
                    <img src="https://placehold.co/128x128/fce7f3/ec4899?text=?" class="w-32 h-32 rounded-full object-cover mx-auto mb-4 border-4 border-white shadow-lg opacity-70">
                    <h2 class="text-2xl font-bold text-gray-400">–ü–∞—Ä—Ç–Ω—ë—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω</h2>
                    <p class="text-sm text-gray-500 mt-2 mb-4">–°–æ–∑–¥–∞–π—Ç–µ –ø–∞—Ä—É, —á—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–æ–≤–º–µ—Å—Ç–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏.</p>
                     <div class="flex space-x-2">
                        <button onclick="window.app.showInviteModal()" class="flex-1 bg-[var(--accent-pink)] text-[var(--accent-pink-dark)] font-semibold py-3 px-4 rounded-full">–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å</button>
                        <button onclick="window.app.showConnectModal()" class="flex-1 bg-gray-200 text-gray-800 font-semibold py-3 px-4 rounded-full">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
                    </div>
                </div>
                <hr class="my-8 border-t border-gray-200">
                <div class="text-center">
                    <button onclick="window.app.logout()" class="text-red-500 font-semibold">–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞</button>
                </div>`
        };

        // --- –û—Å–Ω–æ–≤–Ω–æ–π –æ–±—ä–µ–∫—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ---
        window.app = {};
        
        // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---
        window.onload = async () => {
            try {
                const firebaseConfig = {
                    apiKey: "AIzaSyAJfeYJ8WcNQRWvuqHQ_aA4VC4n-BH6c",
                    authDomain: "kokoro-36157.firebaseapp.com",
                    projectId: "kokoro-36157",
                    storageBucket: "kokoro-36157.appspot.com",
                    messagingSenderId: "334403348528",
                    appId: "1:334403348528:web:548253f8a6ae00060f0b69",
                    measurementId: "G-FHP6L5Q28S"
                };
                
                const firebaseApp = initializeApp(firebaseConfig);
                db = getFirestore(firebaseApp);
                auth = getAuth(firebaseApp);

                Telegram.WebApp.ready();
                Telegram.WebApp.expand();

                onAuthStateChanged(auth, user => {
                    if (user) {
                        if (Telegram.WebApp.initDataUnsafe?.user) {
                            tgUser = Telegram.WebApp.initDataUnsafe.user;
                            userId = tgUser.id.toString();
                            window.app.loginWithTelegram();
                        } else {
                            loadingContainer.style.display = 'none';
                            loginContainer.style.display = 'flex';
                        }
                    } else {
                        signInAnonymously(auth).catch(error => console.error("Anonymous sign-in failed:", error));
                    }
                });
            } catch (error) {
                console.error("Initialization failed:", error);
                loadingContainer.innerHTML = "–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å (F12).";
            }
        };

        const pageTitles = { home: 'Kokoro ‚ù§Ô∏è', calendar: '–ö–∞–ª–µ–Ω–¥–∞—Ä—å', chat: '–ß–∞—Ç', games: '–ò–≥—Ä—ã', profile: '–ü—Ä–æ—Ñ–∏–ª—å' };

        window.navigate = function(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            const pageContainer = document.getElementById(`page-${pageId}`);
            if (pageTemplates[pageId] && !pageContainer.innerHTML.trim()) {
                pageContainer.innerHTML = pageTemplates[pageId];
            }
            pageContainer.classList.add('active');

            document.getElementById('header-title').textContent = pageTitles[pageId];
            document.querySelectorAll('.nav-item').forEach(item => {
                const isActive = item.getAttribute('onclick').includes(`'${pageId}'`);
                item.classList.toggle('active', isActive);
                item.classList.toggle('text-[var(--accent-lavender-dark)]', isActive);
                item.classList.toggle('text-[var(--text-secondary)]', !isActive);
            });
        }
        
        Object.assign(window.app, {
            async loginWithTelegram() {
                if (!tgUser) {
                    tgUser = { id: Date.now(), first_name: 'Test', last_name: 'User', username: 'testuser' };
                    userId = tgUser.id.toString();
                }
                const userRef = doc(db, "users", userId);
                const userSnap = await getDoc(userRef);
                if (!userSnap.exists()) {
                    await setDoc(userRef, { id: userId, firstName: tgUser.first_name, lastName: tgUser.last_name || '', username: tgUser.username || '', partnerId: null, coupleId: null });
                }
                this.startApp();
            },
            startApp() {
                loginContainer.style.display = 'none';
                loadingContainer.style.display = 'none';
                appContainer.style.display = 'flex';
                if (unsubscribeUser) unsubscribeUser();
                unsubscribeUser = onSnapshot(doc(db, "users", userId), (docSnap) => {
                    const userData = docSnap.data();
                    if (userData) {
                        this.updateProfileUI(userData);
                        this.updatePartnerUI(userData);
                    }
                });
                window.navigate('home');
            },
            updateProfileUI(userData) {
                const nicknameEl = document.getElementById('profile-nickname');
                const avatarEl = document.getElementById('profile-avatar');
                const userIdEl = document.getElementById('user-id-display');
                if (nicknameEl) nicknameEl.textContent = userData.firstName || userData.username;
                if (avatarEl) avatarEl.src = `https://placehold.co/128x128/e5e7ff/818cf8?text=${(userData.firstName || 'U').charAt(0)}`;
                if (userIdEl) userIdEl.textContent = userData.id;
            },
            async updatePartnerUI(userData) {
                const inviteView = document.getElementById('invite-view');
                const partnerView = document.getElementById('partner-view');
                if (!inviteView || !partnerView) return;
                if (userData.partnerId) {
                    inviteView.style.display = 'none';
                    partnerView.style.display = 'block';
                    const partnerSnap = await getDoc(doc(db, "users", userData.partnerId));
                    if (partnerSnap.exists()) {
                        const partnerData = partnerSnap.data();
                        document.getElementById('partner-nickname').textContent = partnerData.firstName || partnerData.username;
                        document.getElementById('partner-avatar').src = `https://placehold.co/128x128/fce7f3/ec4899?text=${(partnerData.firstName || 'P').charAt(0)}`;
                    }
                } else {
                    inviteView.style.display = 'block';
                    partnerView.style.display = 'none';
                }
            },
            logout() {
                if (unsubscribeUser) unsubscribeUser();
                appContainer.style.display = 'none';
                loginContainer.style.display = 'flex';
            },
            async connectPartner() {
                const partnerIdInput = document.getElementById('partner-id-input');
                const partnerId = partnerIdInput.value.trim();
                if (!partnerId || partnerId === userId) {
                    Telegram.WebApp.showAlert("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π ID –ø–∞—Ä—Ç–Ω—ë—Ä–∞.");
                    return;
                }
                const partnerRef = doc(db, "users", partnerId);
                const partnerSnap = await getDoc(partnerRef);
                if (!partnerSnap.exists() || partnerSnap.data().partnerId) {
                    Telegram.WebApp.showAlert("–ü–∞—Ä—Ç–Ω—ë—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ —É–∂–µ —Å–æ—Å—Ç–æ–∏—Ç –≤ –ø–∞—Ä–µ.");
                    return;
                }
                const coupleId = [userId, partnerId].sort().join('_');
                await updateDoc(doc(db, "users", userId), { partnerId: partnerId, coupleId: coupleId });
                await updateDoc(doc(db, "users", partnerId), { partnerId: userId, coupleId: coupleId });
                await setDoc(doc(db, "couples", coupleId), { members: [userId, partnerId] });
                this.closeAllModals();
                partnerIdInput.value = '';
            },
            disconnectPartner() {
                Telegram.WebApp.showConfirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Ä–∞–∑–æ—Ä–≤–∞—Ç—å —Å–≤—è–∑—å?", async (ok) => {
                    if (ok) {
                        const userSnap = await getDoc(doc(db, "users", userId));
                        const partnerId = userSnap.data()?.partnerId;
                        if (partnerId) {
                            await updateDoc(doc(db, "users", userId), { partnerId: null, coupleId: null });
                            await updateDoc(doc(db, "users", partnerId), { partnerId: null, coupleId: null });
                        }
                    }
                });
            },
            showInviteModal: () => document.getElementById('invite-modal').classList.remove('modal-hidden'),
            showConnectModal: () => document.getElementById('connect-modal').classList.remove('modal-hidden'),
            closeAllModals: () => {
                document.getElementById('invite-modal').classList.add('modal-hidden');
                document.getElementById('connect-modal').classList.add('modal-hidden');
            },
            copyUserId: () => {
                navigator.clipboard.writeText(userId).then(() => Telegram.WebApp.showAlert("ID —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!"));
            },
            sendThinking: () => {
                const notification = document.getElementById('notification');
                notification.textContent = 'üíñ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!';
                notification.classList.remove('opacity-0', 'translate-y-[-20px]');
                notification.classList.add('opacity-100', 'translate-y-0');
                setTimeout(() => {
                    notification.classList.remove('opacity-100', 'translate-y-0');
                    notification.classList.add('opacity-0', 'translate-y-[-20px]');
                }, 2000);
            },
            async callGemini(prompt) {
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                const payload = { contents: [{ parts: [{ text: prompt }] }] };
                try {
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) throw new Error(`API call failed with status: ${response.status}`);
                    const result = await response.json();
                    return result.candidates?.[0]?.content?.parts?.[0]?.text || "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç.";
                } catch (error) {
                    console.error("Error calling Gemini API:", error);
                    return "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ AI.";
                }
            },
            async generateDateIdea() {
                const ideaContainer = document.getElementById('date-idea-content');
                const ideaButton = document.getElementById('date-idea-button');
                ideaContainer.innerHTML = `<div class="animate-spin rounded-full h-8 w-8 border-b-2 border-yellow-800"></div>`;
                ideaButton.disabled = true;
                const prompt = "–ü—Ä–∏–¥—É–º–∞–π –∫–æ—Ä–æ—Ç–∫—É—é, –∫—Ä–µ–∞—Ç–∏–≤–Ω—É—é –∏ —Ä–æ–º–∞–Ω—Ç–∏—á–µ—Å–∫—É—é –∏–¥–µ—é –¥–ª—è —Å–≤–∏–¥–∞–Ω–∏—è –¥–ª—è –ø–∞—Ä—ã. –û–ø–∏—à–∏ –µ–µ –≤ –æ–¥–Ω–æ–º –∞–±–∑–∞—Ü–µ. –û—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.";
                ideaContainer.textContent = await this.callGemini(prompt);
                ideaButton.disabled = false;
            },
            async generateTruthOrDare(type) {
                const container = document.getElementById('truth-dare-content');
                const truthBtn = document.getElementById('truth-btn');
                const dareBtn = document.getElementById('dare-btn');
                container.innerHTML = `<div class="animate-spin rounded-full h-8 w-8 border-b-2 border-[var(--accent-lavender-dark)]"></div>`;
                truthBtn.disabled = true;
                dareBtn.disabled = true;
                const prompt = type === 'truth'
                    ? "–ü—Ä–∏–¥—É–º–∞–π –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π –∏ —Ä–æ–º–∞–Ω—Ç–∏—á–Ω—ã–π –≤–æ–ø—Ä–æ—Å '–ü—Ä–∞–≤–¥–∞' –¥–ª—è –∏–≥—Ä—ã –≤–ª—é–±–ª–µ–Ω–Ω–æ–π –ø–∞—Ä—ã."
                    : "–ü—Ä–∏–¥—É–º–∞–π –≤–µ—Å–µ–ª–æ–µ –∏ —Ä–æ–º–∞–Ω—Ç–∏—á–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ '–î–µ–π—Å—Ç–≤–∏–µ' –¥–ª—è –∏–≥—Ä—ã –≤–ª—é–±–ª–µ–Ω–Ω–æ–π –ø–∞—Ä—ã.";
                container.textContent = await this.callGemini(prompt);
                truthBtn.disabled = false;
                dareBtn.disabled = false;
            }
        });
        
    </script>
</body>
</html>
